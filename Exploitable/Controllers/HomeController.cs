using Exploitable.Models;
using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace Exploitable.Controllers
{
    public class HomeController : Controller
    {
        // GET: Home
        public ActionResult Index()
        {
            UserModel viewModel = new UserModel();
            //sql command for users
            string queryString = "select top 10 Username, Password from [User]";
            string connectionString = "Data Source=exploitproject.cyvy3zrxkjpu.us-west-2.rds.amazonaws.com,1433;Database=ExploitProject;User ID=exploit_user;Password=BgGDj4SU7xqnTVeL;";
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                SqlCommand command = new SqlCommand(queryString, connection);
                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                try
                {
                    while (reader.Read())
                    {
                        User user = new User()
                        {
                            Username = reader[0].ToString(),
                            Email = reader[1].ToString()
                        };
                        viewModel.Users.Add(user);
                    }
                }
                finally
                {
                    // Always call Close when done reading.
                    reader.Close();
                }
            }
            return View(viewModel);
        }

        public ActionResult Authentication()
        {
            User user = new User();
            return View(user);
        }

        [HttpPost]
        public ActionResult Authentication(User user)
        {
            string connectionString = "Data Source=exploitproject.cyvy3zrxkjpu.us-west-2.rds.amazonaws.com;Database=ExploitProject;User ID=exploit_user;Password=BgGDj4SU7xqnTVeL;";
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                SqlCommand command = new SqlCommand("SELECT * FROM [User] WHERE Username='" + user.Username + "' AND Password='" + user.Password + "'");
                command.Connection = connection;
                connection.Open();

                SqlDataReader reader = command.ExecuteReader();
                try
                {
                    while (reader.Read())
                    {
                        if (reader.HasRows)
                        {
                            return View("Welcome");
                        }
                    }
                }
                finally { reader.Close(); }

                //return with error
                return View();
            }
        }

        public ActionResult Welcome()
        {
            return View();
        }

        public ActionResult Register()
        {
            User user = new User();
            return View(user);
        }

        [HttpPost]
        public ActionResult Register(User user)
        {
            string connectionString = "Data Source=exploitproject.cyvy3zrxkjpu.us-west-2.rds.amazonaws.com;Database=ExploitProject;User ID=exploit_user;Password=BgGDj4SU7xqnTVeL;";
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Open();
                using (SqlCommand command = connection.CreateCommand())
                {
                    command.CommandText = "INSERT INTO [User](last_name,email,ip_address) VALUES(@param1,@param2,@param3)";

                    command.Parameters.AddWithValue("@param1", user.Username);
                    command.Parameters.AddWithValue("@param2", user.Email);
                    command.Parameters.AddWithValue("@param3", user.Password);

                    command.ExecuteNonQuery();
                }
            }
            return View();
        }
    }
}